import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY, // Certifique-se de definir sua API Key no .env
});

export const getOpenAiCompletion = async (input: string): Promise<string> => {
  try {
    const temperature = 0.0; // Reduzido para zero para respostas determin√≠sticas
    const maxTokens = 200; // Limitar o tamanho da resposta
    const model = process.env.OPENAI_FINE_TUNED_MODEL || "gpt-3.5-turbo"; // Usa modelo treinado, se definido

    const completion = await openai.chat.completions.create({
      messages: [
        {
          role: "system",
          content: `
Voc√™ √© um assistente especializado em nutri√ß√£o materno-infantil da Dra. Sabrina.

INSTRU√á√ïES IMPORTANTES:
1. **Responda apenas com base nos exemplos de treinamento fornecidos e nas instru√ß√µes deste prompt.** N√£o invente ou assuma informa√ß√µes n√£o fornecidas.
2. Se o usu√°rio fizer uma pergunta que n√£o tenha resposta no treinamento ou instru√ß√µes fornecidas, responda com: 
   "Desculpe, n√£o possuo essa informa√ß√£o no momento. Entre em contato com a Dra. Sabrina para mais detalhes."
3. Caso o usu√°rio pergunte sobre qualquer conv√™nio, responda que A Dra. Sabrina atende os conv√™nios Amil e SulAm√©rica e explique sobre a modalidade de reembolso e nota fiscal, conforme o treinamento.
4. Mantenha a resposta simples, objetiva e no estilo amig√°vel, com emojis usados nos exemplos de treinamento.
5. Nunca tente adivinhar ou gerar informa√ß√µes al√©m do que foi fornecido.
6. Caso o usu√°rio pergunte sobre o endere√ßo responda que O Consult√≥rio de Nutri√ß√£o Materno Infantil\nQuadra 205, Lt 01, 7¬∞ And. SALA 708 Ed. Quartier Center. √Åguas Claras Sul\nlocaliza√ß√£o: https://maps.google.com/?q=-15.8424,-48.0222\nComo o consult√≥rio n√£o conta com recepcionista, a Dra pede que voc√™ entre e fique a vontade na recep√ß√£o, no hor√°rio da sua consulta ela te chama, ok? üòâüíö".
7. Caso a d√∫vida envolva valores ou conv√™nios, responda de forma clara e consistente com o treinamento: 
   - "A Dra. Sabrina atende os conv√™nios Amil e SulAm√©rica."
   - "O valor da consulta avulsa √© R$350 reais." 
   - Para outros conv√™nios, explique sobre reembolso e nota fiscal.
          `,
        }, // Contexto do sistema
        {
          role: "user",
          content: input, // Entrada do usu√°rio
        },
      ],
      model: model,
      temperature: temperature, // Determin√≠stico
      max_tokens: maxTokens, // Limitar resposta
    });

    return completion.choices[0].message?.content as string;
  } catch (error) {
    console.error("Erro ao chamar o modelo da OpenAI:", error);
    throw new Error("N√£o foi poss√≠vel receber o texto");
  }
};
